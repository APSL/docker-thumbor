version: '2'
services:

  imageserver:
    image: python:3
    ports:
      - "127.0.0.1:8080:8000"
    volumes:
      - ./tests/images/v1:/data
    command: ["python3", "-m",  "http.server", "--directory=/data"]
    networks:
      - app

  thumbor-base:
    build: 
      dockerfile: thumbor-base.dockerfile
      context: thumbor
    image: apsl/thumbor:build-base
    env_file: .travis.env
    volumes:
      - ./data:/data
    links:
      - redis:redis
      - imageserver:imageserver
    ports:
      - "127.0.0.1:8091:8000"
    networks:
      - app

  thumbor-full:
    build: 
      dockerfile: thumbor-full.dockerfile
      context: thumbor
      args:
        - FROMTAG=build-base      
    image: apsl/thumbor:build-full
    env_file: .travis.env
    volumes:
      - ./data:/data
    links:
      - redis:redis
      - imageserver:imageserver
    ports:
      - "127.0.0.1:8091:8000"
    depends_on: 
      - thumbor-base
    networks:
      - app      

  thumbor-multiprocess-base:
    build: 
      dockerfile: thumbor-multiprocess-base.dockerfile
      context: thumbor-multiprocess
      args:
        - FROMTAG=build-base      
    image: apsl/thumbor:build-multiprocess-base
    env_file: .travis.env
    volumes:
      - ./data:/data
    links:
      - redis:redis
      - imageserver:imageserver
    ports:
      - "127.0.0.1:8091:8000"
    depends_on: 
      - thumbor-base      
    networks:
      - app

  thumbor-multiprocess-full:
    build: 
      dockerfile: thumbor-multiprocess-full.dockerfile
      context: thumbor-multiprocess
      args:
        - FROMTAG=build-multiprocess-base
    image: apsl/thumbor:build-multiprocess-full
    env_file: .travis.env
    volumes:
      - ./data:/data
    links:
      - redis:redis
      - imageserver:imageserver
    ports:
      - "127.0.0.1:8091:8000"
    depends_on: 
      - thumbor-multiprocess-base      
    networks:
      - app

  nginx:
    build: nginx
    image: apsl/thumbor:nginx-build
    links:
      - thumbor-base:thumbor
    volumes_from:
      - thumbor-base:ro
    ports:
      - "127.0.0.1:8097:80"
    hostname: nginx
    networks:
      - app

  redis:
    image: redis:latest
    networks:
      - app

volumes:
  data:
    driver: local

networks:
  app:
    driver: bridge
