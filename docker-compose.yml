version: '2'
services:

  imageserver:
    image: python:3
    ports:
      - "127.0.0.1:8080:8000"
    volumes:
      - ./tests/images/v1:/data
    command: ["python3", "-m",  "http.server", "--directory=/data"]
    networks:
      - app

  thumbor:
    build: thumbor
    image: apsl/thumbor:6.3.0
    env_file: env
    volumes:
      - data:/data
    links:
      - redis:redis
    ports:
      - "8000:8000"      
    networks:
      - app

  thumbor-secure:
    build: thumbor
    env_file: env
    environment:
      STORAGE: thumbor.storages.file_storage
      RESULT_STORAGE: thumbor.result_storages.file_storage
      RESULT_STORAGE_STORES_UNSAFE: "False"
      ALLOW_UNSAFE_URL: "False"
      SECURITY_KEY: safetythumbor
    volumes:
      - data:/data
    ports:
      - "8000:8000"
    networks:
      - app

  nginx:
    build: nginx
    links:
      - thumbor:thumbor
    env_file: env
    volumes_from:
      - thumbor
    ports:
      - "8169:8000"
    hostname: nginx
    networks:
      - app

  redis:
    image: redis:latest
    networks:
      - app


volumes:
  data:
    driver: local

networks:
  app:
    driver: bridge
